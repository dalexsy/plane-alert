<div class="window-view-overlay">
  <div
    *ngIf="windowCloudUrl"
    class="cloud-background"
    [style.backgroundImage]="'url(' + windowCloudUrl + ')'"
  ></div>
  <div class="compass-labels">
    <span class="compass-label">S</span>
    <span class="compass-label">W</span>
    <span class="compass-label">N</span>
    <span class="compass-label">E</span>
    <span class="compass-label">S</span>
  </div>
  <!-- full-height start/end lines (absolute in overlay) -->
  <ng-container *ngFor="let plane of windowViewPlanes">
    <ng-container
      *ngIf="
        plane.isMarker &&
        (plane.callsign.endsWith('Start') || plane.callsign.endsWith('End'))
      "
    >
      <div
        class="vertical-line"
        [ngClass]="{
          'balcony-marker': plane.callsign.startsWith('Balcony'),
          'streetside-marker': plane.callsign.startsWith('Streetside')
        }"
        [style.left]="plane.x + '%'"
      ></div>
    </ng-container>
  </ng-container>
  <div class="altitude-bands">
    <ng-container *ngFor="let tick of altitudeTicks; let i = index">
      <ng-container *ngIf="i < altitudeTicks.length - 1">
        <div
          class="altitude-band-color"
          [style.bottom]="tick.y + '%'"
          [style.height]="altitudeTicks[i + 1].y - tick.y + '%'"
          [style.background]="tick.color"
        ></div>
      </ng-container>
    </ng-container>
  </div>
  <div class="planes-container">
    <ng-container *ngFor="let plane of windowViewPlanes">
      <div
        class="plane-dot"
        [ngClass]="{
          'balcony-marker':
            plane.isMarker && plane.callsign.startsWith('Balcony'),
          'streetside-marker':
            plane.isMarker && plane.callsign.startsWith('Streetside'),
          'half-left': plane.x < 50,
          'half-right': plane.x >= 50
        }"
        [class.dimmed]="plane.distanceKm != null && plane.distanceKm > 70"
        [style.left]="plane.x + '%'"
        [style.bottom]="plane.y + '%'"
        [style.transformOrigin]="'bottom center'"
        [title]="plane.isMarker ? '' : ' (' + plane.altitude + 'm)'"
      >
        <!-- Marker label for midpoints (Balcony/Streetside) -->
        <ng-container
          *ngIf="
            plane.isMarker &&
            !(
              plane.callsign.endsWith('Start') || plane.callsign.endsWith('End')
            )
          "
        >
          <span class="line-label">{{ plane.callsign }}</span>
        </ng-container>
        <!-- real planes (aircraft icons) -->
        <ng-container *ngIf="!plane.isMarker && !plane.isCelestial">
          <!-- use helicopter icon for helicopters -->
          <ng-container *ngIf="plane.isHelicopter">
            <span
              class="copter-wrapper"
              [style.transform]="'scale(' + (plane.scale || 1) + ')'"
              [style.transformOrigin]="'center center'"
            >
              <span
                class="copter-plane-icon material-symbols-sharp"
                [attr.aria-label]="plane.callsign + ' helicopter'"
              >
                toys_fan
              </span>
            </span>
          </ng-container>
          <!-- fixed-wing planes with chemtrail and icon -->
          <ng-container *ngIf="!plane.isHelicopter">
            <div
              class="icon-scale-wrapper"
              [style.transform]="'scale(' + (plane.scale || 1) + ')'"
              [style.transformOrigin]="'bottom center'"
            >
              <div
                class="icon-wrapper"
                [style.transform]="getPerspectiveTransform(plane)"
                [style.transformOrigin]="'center center'"
              >
                <div
                  class="chemtrail"
                  [style.width.px]="plane.trailLength"
                  [style.background]="
                    'rgba(255,255,255,' + plane.trailOpacity + ')'
                  "
                  [style.transform]="
                    'rotateZ(' +
                    ((plane.bearing ?? 0) + (plane.x < 50 ? 45 : 0)) +
                    'deg)'
                  "
                ></div>
                <svg
                  class="plane-icon {{ plane.iconType }}"
                  viewBox="0 0 64 64"
                  [attr.aria-label]="
                    plane.callsign + ' at ' + plane.altitude + 'm'
                  "
                  [style.transform]="
                    'rotateZ(' +
                    ((plane.bearing ?? 0) + (plane.x > 50 ? -90 : -45)) +
                    'deg)'
                  "
                  [style.transformOrigin]="'center center'"
                >
                  <path [attr.d]="plane.iconPath"></path>
                </svg>
              </div>
            </div>
          </ng-container>
          <span
            class="plane-label"
            [class.followed]="plane.icao === highlightedPlaneIcao"
            [style.color]="
              planeStyle.getLabelColor(
                plane,
                plane.icao === highlightedPlaneIcao
              )
            "
            (click)="handleLabelClick(plane, $event)"
          >
            {{ plane.callsign }}
          </span>
        </ng-container>
        <!-- celestial markers (Sun/Moon icons) -->
        <ng-container *ngIf="plane.isCelestial">
          <span
            class="celestial-wrapper"
            [style.transform]="'scale(1)'"
            [style.transformOrigin]="'center center'"
          >
            <!-- Sun: simple filled circle, visually dimmed or outlined if below horizon -->
            <span
              *ngIf="plane.celestialBodyType === 'sun'"
              class="celestial-circle"
              [ngClass]="{ 'below-horizon': plane.belowHorizon }"
              aria-label="Sun marker"
            ></span>
            <!-- Moon: SVG with phase mask, orientation faces sun, visually dimmed/outlined if below horizon -->
            <svg
              *ngIf="plane.celestialBodyType === 'moon'"
              class="moon-svg"
              width="22"
              height="22"
              viewBox="0 0 22 22"
              [attr.aria-label]="
                'Moon marker, phase: ' + (plane.moonPhase | number : '1.2-2')
              "
              [style.transform]="
                'rotateZ(' + ((plane.moonAngle || 0) + 180) + 'deg)'
              "
              [style.transformOrigin]="'center center'"
            >
              <!-- Full or New Moon: unmasked circle -->
              <ng-container
                *ngIf="
                  plane.moonFraction !== undefined &&
                  (plane.moonFraction >= 0.98 || plane.moonFraction <= 0.02)
                "
              >
                <circle
                  cx="11"
                  cy="11"
                  r="10"
                  [ngClass]="{ 'below-horizon': plane.belowHorizon }"
                  stroke="currentColor"
                  [attr.fill]="
                    plane.moonFraction! >= 0.98 ? 'currentColor' : 'none'
                  "
                />
              </ng-container>
              <!-- Partial phases: mask shadow when fraction<=0.5 -->
              <ng-container
                *ngIf="
                  plane.moonFraction !== undefined &&
                  plane.moonFraction > 0.02 &&
                  plane.moonFraction <= 0.5
                "
              >
                <defs>
                  <mask id="moon-mask-{{ plane.x }}-{{ plane.y }}">
                    <rect width="22" height="22" fill="white" />
                    <circle
                      cy="11"
                      r="10"
                      [attr.cx]="11 + (2 * plane.moonFraction! - 1) * 10"
                      fill="black"
                    />
                  </mask>
                </defs>
                <circle
                  cx="11"
                  cy="11"
                  r="10"
                  [ngClass]="{ 'below-horizon': plane.belowHorizon }"
                  stroke="currentColor"
                  fill="currentColor"
                  [attr.mask]="
                    'url(#moon-mask-' + plane.x + '-' + plane.y + ')+'
                  "
                />
              </ng-container>
              <!-- Partial phases: mask lit portion when fraction>0.5 -->
              <ng-container
                *ngIf="
                  plane.moonFraction !== undefined &&
                  plane.moonFraction > 0.5 &&
                  plane.moonFraction < 0.98
                "
              >
                <defs>
                  <mask id="moon-mask-lit-{{ plane.x }}-{{ plane.y }}">
                    <rect width="22" height="22" fill="black" />
                    <ellipse
                      cy="11"
                      [attr.rx]="10 * (2 * plane.moonFraction! - 1)"
                      ry="10"
                      cx="11"
                      fill="white"
                    />
                  </mask>
                </defs>
                <circle
                  cx="11"
                  cy="11"
                  r="10"
                  [ngClass]="{ 'below-horizon': plane.belowHorizon }"
                  stroke="currentColor"
                  fill="currentColor"
                  [attr.mask]="
                    'url(#moon-mask-lit-' + plane.x + '-' + plane.y + ')+'
                  "
                />
              </ng-container>
            </svg>
          </span>
        </ng-container>
      </div>
    </ng-container>
  </div>
</div>
